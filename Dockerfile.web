# CrackHouse Dockerfile for Web Frontend
# Supports development, test, and production builds

# Base stage with pnpm
FROM node:20-alpine AS base
# Install pnpm globally and curl for health checks
RUN npm install -g pnpm@10.4.1 && apk add --no-cache curl dumb-init

# Set working directory
WORKDIR /app

# Copy all package files first for better Docker layer caching
COPY package*.json pnpm-lock.yaml* ./
COPY packages/ui/package*.json ./packages/ui/
COPY packages/eslint-config/package*.json ./packages/eslint-config/
COPY packages/typescript-config/package*.json ./packages/typescript-config/
COPY apps/web/package*.json ./apps/web/
COPY apps/api/package*.json ./apps/api/
COPY turbo.json ./

# Development target
FROM base AS development
ENV NODE_ENV=development

# Install all dependencies (including devDependencies for development)
RUN pnpm install --frozen-lockfile

# Copy source code
COPY apps/web/src ./apps/web/src
COPY apps/web/public ./apps/web/public
COPY packages ./packages

# Create non-root user and cache directory with proper permissions
RUN addgroup -g 1001 -S nodejs && \
    adduser -S webuser -u 1001 && \
    mkdir -p /app/.turbo/cache && \
    chown -R webuser:nodejs /app

# Set working directory to web app
WORKDIR /app/apps/web

# Switch to non-root user
USER webuser

# Expose port
EXPOSE 3000

# Health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=60s --retries=3 \
    CMD curl -f http://localhost:3000 || exit 1

# Start development server using npx
CMD ["npx", "next", "dev"]

# Production target - use pre-built assets
FROM base AS production
ENV NODE_ENV=production

# Copy pre-built application (assumes local build was done)
COPY --chown=webuser:nodejs apps/web/.next ./apps/web/.next
COPY --chown=webuser:nodejs apps/web/public ./apps/web/public
COPY --chown=webuser:nodejs apps/web/package.json ./apps/web/
COPY --chown=webuser:nodejs apps/web/next.config.js* ./apps/web/

# Create non-root user for security
RUN addgroup -g 1001 -S nodejs && \
    adduser -S webuser -u 1001 && \
    chown -R webuser:nodejs /app

# Set working directory to web app
WORKDIR /app/apps/web

# Switch to non-root user
USER webuser

# Expose port
EXPOSE 3000

# Health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=60s --retries=3 \
    CMD curl -f http://localhost:3000 || exit 1

# Start production server with dumb-init
ENTRYPOINT ["dumb-init", "--"]
CMD ["npx", "next", "start"]
