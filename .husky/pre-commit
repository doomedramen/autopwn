#!/usr/bin/env sh

echo "üîç Running pre-commit hooks..."

# Stash unstaged changes to run against only staged files
STASH_OUTPUT=$(git stash push -k -u -m "pre-commit stash" 2>/dev/null)
trap 'git stash pop >/dev/null 2>&1 || true' EXIT

# Fast checks - run against staged files only
echo "  üìù Running TypeScript type check..."
pnpm tsc --noEmit

echo "  üîß Running ESLint with auto-fix..."
# Run on staged files only
STAGED_JS_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(js|jsx|ts|tsx)$' | tr '\n' ' ')
if [ -n "$STAGED_JS_FILES" ]; then
  pnpm exec eslint $STAGED_JS_FILES --fix
  # Re-stage any auto-fixed files
  git add $STAGED_JS_FILES
else
  echo "    ‚ÑπÔ∏è  No JavaScript/TypeScript files staged"
fi

echo "  üé® Checking code formatting..."
# Check only staged files
STAGED_FORMAT_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(js|jsx|ts|tsx|json|md|yml|yaml)$' | tr '\n' ' ')
if [ -n "$STAGED_FORMAT_FILES" ]; then
  echo "$STAGED_FORMAT_FILES" | xargs pnpm exec prettier --check --ignore-unknown
else
  echo "    ‚ÑπÔ∏è  No files to format check"
fi

# Quick security check
echo "  üîí Running quick security audit..."
pnpm audit --audit-level moderate || echo "    ‚ö†Ô∏è  Security audit completed with warnings"

echo "‚úÖ Pre-commit hooks passed!"