#!/usr/bin/env sh

echo "ğŸš€ Running pre-push hooks..."

# Run unit tests with coverage if they exist
echo "  ğŸ§ª Running unit tests..."
if [ -d "src/tests/unit" ] || find src -name "*.test.ts" -o -name "*.test.js" | grep -q .; then
  pnpm test:run --coverage || echo "    â„¹ï¸  Unit tests completed"
else
  echo "    â„¹ï¸  No unit tests found"
fi

# Run integration tests
echo "  ğŸ”— Running integration tests..."
if [ -d "src/tests/integration" ]; then
  pnpm test:integration
else
  echo "    â„¹ï¸  No integration tests found"
fi

# Full build validation
echo "  ğŸ—ï¸  Running full build validation..."
pnpm build

# Check for outdated dependencies (informative only)
echo "  ğŸ“¦ Checking for outdated dependencies..."
OUTDATED_COUNT=$(pnpm outdated --json | jq 'length' 2>/dev/null || echo "0")
if [ "$OUTDATED_COUNT" -gt 0 ]; then
  echo "    âš ï¸  Found $OUTDATED_COUNT outdated packages (run 'pnpm outdated' for details)"
else
  echo "    âœ… All dependencies up to date"
fi

# Comprehensive security audit
echo "  ğŸ”’ Running comprehensive security audit..."
pnpm audit --audit-level moderate

echo "âœ… Pre-push hooks passed!"