#!/usr/bin/env sh

echo "🚀 Running pre-push hooks..."

# Run unit tests with coverage if they exist
echo "  🧪 Running unit tests..."
if [ -d "src/tests/unit" ] || find src -name "*.test.ts" -o -name "*.test.js" | grep -q .; then
  pnpm test:run --coverage || echo "    ℹ️  Unit tests completed"
else
  echo "    ℹ️  No unit tests found"
fi

# Run integration tests
echo "  🔗 Running integration tests..."
if [ -d "src/tests/integration" ]; then
  pnpm test:integration
else
  echo "    ℹ️  No integration tests found"
fi

# Full build validation
echo "  🏗️  Running full build validation..."
pnpm build

# Check for outdated dependencies (informative only)
echo "  📦 Checking for outdated dependencies..."
OUTDATED_COUNT=$(pnpm outdated --json | jq 'length' 2>/dev/null || echo "0")
if [ "$OUTDATED_COUNT" -gt 0 ]; then
  echo "    ⚠️  Found $OUTDATED_COUNT outdated packages (run 'pnpm outdated' for details)"
else
  echo "    ✅ All dependencies up to date"
fi

# Comprehensive security audit
echo "  🔒 Running comprehensive security audit..."
pnpm audit --audit-level moderate

echo "✅ Pre-push hooks passed!"