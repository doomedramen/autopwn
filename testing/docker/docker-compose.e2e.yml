# Docker Compose for E2E Testing
# Run from repo root: docker compose -f testing/docker/docker-compose.e2e.yml up --abort-on-container-exit --build

services:
  # PostgreSQL database
  postgres:
    image: postgres:16-alpine
    container_name: crackhouse-e2e-postgres
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: password
      POSTGRES_DB: autopwn_test
    network_mode: host
    command: -p 5433
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -p 5433"]
      interval: 2s
      timeout: 5s
      retries: 10

  # Redis for job queues
  redis:
    image: redis:7-alpine
    container_name: crackhouse-e2e-redis
    command: redis-server --port 6380
    network_mode: host
    healthcheck:
      test: ["CMD", "redis-cli", "-p", "6380", "ping"]
      interval: 2s
      timeout: 5s
      retries: 10

  # E2E Test Runner (includes API, Worker, Web, and Playwright)
  e2e-tests:
    build:
      context: ../..
      dockerfile: testing/docker/Dockerfile.e2e
    container_name: crackhouse-e2e
    environment:
      - NODE_ENV=test
      - DATABASE_URL=postgresql://postgres:password@localhost:5433/autopwn_test
      - REDIS_URL=redis://localhost:6380
      - REDIS_HOST=localhost
      - REDIS_PORT=6380
      - BASE_URL=http://localhost:3000
      - NEXT_PUBLIC_API_URL=http://localhost:3001
      - AUTH_SECRET=test-secret-key-for-e2e-testing-minimum-32-chars
      - JWT_SECRET=test-jwt-secret-key-for-e2e-testing-minimum-32-chars
      - UPLOAD_DIR=./uploads/test
    volumes:
      # Mount source code for live development
      - ../../apps:/crackhouse/apps
      - ../../packages:/crackhouse/packages
      - ../../scripts:/crackhouse/scripts
      # Keep node_modules in container for faster rebuilds
      - /crackhouse/node_modules
      - /crackhouse/apps/api/node_modules
      - /crackhouse/apps/web/node_modules
      - /crackhouse/packages/*/node_modules
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    network_mode: host
